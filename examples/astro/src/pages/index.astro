---
import { FetchBlocks, FetchPage } from 'rotion';
import NotionPage from '../components/NotionPage';
import 'rotion/style-without-dark.css';

// Get configuration from environment variables
const apiToken = import.meta.env.NOTION_TOKEN;
const pageId = import.meta.env.NOTION_PAGE_ID;

// Set process.env for Rotion (it expects NOTION_TOKEN)
if (apiToken) {
  process.env.NOTION_TOKEN = apiToken;
}

let blocks = [];
let pageTitle = '';
let error = null;

if (!pageId) {
  error = 'Please set NOTION_PAGE_ID in your .env file';
} else if (!apiToken) {
  error = 'Please set NOTION_TOKEN in your .env file';
} else {
  try {
    // Fetch page metadata to get the title
    const page = await FetchPage({ page_id: pageId });

    // Extract title from properties
    if ('properties' in page) {
      for (const [key, property] of Object.entries(page.properties)) {
        if (property.type === 'title' && 'title' in property) {
          pageTitle = property.title.map((t: any) => t.plain_text).join('');
          break;
        }
      }
    }

    // Fetch blocks for content
    blocks = await FetchBlocks({ block_id: pageId });
  } catch (err) {
    error = err instanceof Error ? err.message : 'Failed to fetch Notion page';
  }
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rotion Astro Example</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
      }
      .error {
        padding: 40px;
        max-width: 600px;
        margin: 0 auto;
      }
      .error h2 {
        color: #e74c3c;
        margin-bottom: 16px;
      }
      .error p {
        margin-bottom: 12px;
        line-height: 1.6;
      }
      .error ul {
        background-color: #f8f9fa;
        padding: 20px 20px 20px 40px;
        border-radius: 4px;
        margin-top: 12px;
      }
      .error li {
        margin-bottom: 8px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    {error ? (
      <div class="error">
        <h2>Error</h2>
        <p>{error}</p>
        <p>
          Please check your environment variables in <code>.env</code> file:
        </p>
        <ul>
          <li>NOTION_TOKEN</li>
          <li>NOTION_PAGE_ID</li>
        </ul>
      </div>
    ) : (
      <div class="container">
        {pageTitle && <h1>{pageTitle}</h1>}
        <NotionPage blocks={blocks} client:load />
      </div>
    )}
  </body>
</html>
